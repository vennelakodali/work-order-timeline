<!-- Timeline Header: Title, Timescale Selector, Today Button -->
<app-timeline-header
  [currentTimescale]="timescale"
  (timescaleChange)="onTimescaleChange($event)"
  (todayClick)="scrollToToday()"
/>

<!-- Main Timeline Table -->
<div class="timeline-container" role="region" aria-label="Work order timeline">
  <div class="timeline-scroll-wrapper" #timelineScroll role="table" aria-label="Timeline grid showing work orders across work centers">
    <table class="timeline-table" [style.width.px]="totalTimelineWidth" role="presentation">
      <thead>
        <tr>
          <th class="work-center-header" scope="col"><span>Work Center</span></th>
          <th
            *ngFor="let col of columns; trackBy: trackByColumn"
            class="column-header"
            [style.width.px]="columnWidth"
            scope="col"
            [attr.aria-label]="col.label"
          >
            <span>{{ col.label }}</span>
          </th>
        </tr>
      </thead>
      <tbody>
        <!-- extra row to appease space concerns so as to not add exceptions for all downstream stylings -->
        <tr class="extra-row-for-spacing timeline-row">
          <td class="work-center-cell"></td>
         <td *ngFor="let col of columns; trackBy: trackByColumn" class="column-cell"></td>
        </tr>
        <tr
          *ngFor="let center of workCenters; trackBy: trackByCenter; let isFirst = first"
          class="timeline-row"
          [class.hovered]="(hoveredRowId$ | async) === center.docId"
          (mouseenter)="onRowHover($event, center.docId)"
          (mouseleave)="onRowMouseLeave($event)"
          (mousemove)="onRowMouseMove($event, center.docId)"
          [attr.aria-label]="'Work orders for ' + center.data.name"
        >

          <td class="work-center-cell" role="rowheader" scope="row">
            <span class="work-center-name">{{ center.data.name }}</span>
          </td>
          <td
            *ngFor="let col of columns; trackBy: trackByColumn"
            class="column-cell"
            [class.current-period]="isCurrentPeriod(col)"
            [style.width.px]="columnWidth"
          >
            <!-- Current period pill (only in first row, month view only) -->
            <app-pill
              class="current-period-pill"
              *ngIf="isFirst && isCurrentPeriod(col) && timescale === 'Month'"
              text="Current month"
              textColor="var(--primary-shade)"
              bgColor="var(--current-period-pill-bg)"
            />

            <ng-container *ngIf="col === columns[0]">
              <app-work-order-bar
                *ngFor="let order of getOrdersForCenter(center.docId); trackBy: trackByOrder"
                [order]="order"
                [leftPx]="calcBarStyle(order).left"
                [widthPx]="calcBarStyle(order).width"
                (click)="openEditPanel(order)"
                (edit)="openEditPanel($event)"
                (delete)="onDeleteOrder($event)"
              />
            </ng-container>
          </td>
        </tr>
        <!-- Filler row to take up remaining vertical space -->
        <tr class="filler-row">
          <td class="work-center-cell filler-cell"></td>
          <td class="column-cell filler-cell" *ngFor="let col of columns; trackBy: trackByColumn"></td>
        </tr>
      </tbody>
    </table>

    <!-- Current Day Indicator -->
    <div
      class="today-indicator"
      [style.left.px]="todayPosition"
      role="presentation"
      aria-label="Current day indicator"
    >
      <div class="today-line"></div>
    </div>

    <!-- Hover Button for Rows with No Orders -->
    <app-timeline-hover-button
      [position]="hoverButtonPosition$ | async"
      (buttonClick)="onHoverButtonClick($event)"
      (leave)="onHoverButtonLeave($event)"
    />
  </div>
</div>

<!-- Slide-out Panel for Create/Edit -->
<ng-container *ngIf="panelState$ | async as panelState">
  <app-slide-panel
    *ngIf="panelState.isOpen"
    [mode]="panelState.mode"
    [workCenterId]="panelState.workCenterId"
    [startDate]="panelState.startDate"
    [editingOrder]="panelState.editingOrder"
    (close)="onPanelCloseComplete()"
    (saved)="onPanelSave()"
  />

  <!-- Backdrop overlay when panel is open -->
  <div
    class="panel-backdrop"
    *ngIf="panelState.isOpen"
    (click)="onPanelClose()"
    @fadeIn
  ></div>
</ng-container>
